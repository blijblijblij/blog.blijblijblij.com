<!doctype html><html xmlns=http://www.w3.org/1999/xhtml lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Setup an easy reverse proxy to the biserver | blog.blijblijblij.com</title><meta property="og:title" content="Setup an easy reverse proxy to the biserver - blog.blijblijblij.com"><meta property="og:description" content="Problem You have a biserver serving up information either directly or embedded into some website. You need to open up the biserver to the rest of the world but want to prevent access to certain endpoints. These endpoints might serve only internal consumers, or have security implications.
We need to limit the attack service of a biserver!
Traditionally one would spin up a new server, add an apache config to proxy forward some requests to the backend."><meta property="og:url" content="https://blog.blijblijblij.com/posts/easy-proxy-for-biserver/"><meta property="og:site_name" content="blog.blijblijblij.com"><meta property="og:type" content="article"><meta property="og:image" content="https://blog.blijblijblij.com/images/cover.jpg"><meta property="article:published_time" content="2016-12-10T13:00:00+01:00"><meta property="article:modified_time" content="2016-12-10T13:00:00+01:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@blijblijblij"><meta name=twitter:creator content="@blijblijblij"><link href=https://blog.blijblijblij.com/index.xml rel=alternate type=application/rss+xml title=blog.blijblijblij.com><link rel=stylesheet href=/css/style.css><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical href=https://blog.blijblijblij.com/posts/easy-proxy-for-biserver/><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"></head><body><section class=section><div class=container><nav id=nav-main class=nav><div id=nav-name class=nav-left><a id=nav-anchor class=nav-item href=https://blog.blijblijblij.com/><h1 id=nav-heading class="title is-4">blog.blijblijblij.com</h1></a></div><div class=nav-right><nav id=nav-items class="nav-item level is-mobile"><a class=level-item aria-label=github href=https://github.com/blijblijblij target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></i></span></a><a class=level-item aria-label=twitter href=https://twitter.com/blijblijblij target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></i></span></a><a class=level-item aria-label=instagram href=https://instagram.com/blijblijblij target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"/><path d="M16 11.37A4 4 0 1112.63 8 4 4 0 0116 11.37z"/><line x1="17.5" y1="6.5" x2="17.5" y2="6.5"/></svg></i></span></a><a class=level-item aria-label=email href=mailto:rogier@blijblijblij.com target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></i></span></a><a class=level-item aria-label=linkedin href=https://linkedin.com/in/blijblijblij target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path stroke-width="1.8" d="m5.839218 4.101561c0 1.211972-.974141 2.194011-2.176459 2.194011S1.4863 5.313533 1.4863 4.101561c0-1.211094.974141-2.194011 2.176459-2.194011s2.176459.982917 2.176459 2.194011zm.017552 3.94922h-4.388022v14.04167H5.85677V8.050781zm7.005038.0H8.501869v14.04167h4.360816v-7.370999c0-4.098413 5.291077-4.433657 5.291077.0v7.370999h4.377491v-8.89101c0-6.915523-7.829986-6.66365-9.669445-3.259423V8.050781z"/></svg></i></span></a><a class=level-item aria-label=rss href=/posts/index.xml target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></i></span></a></nav></div></nav><nav class=nav></nav></div><script src=/js/navicon-shift.js></script></section><section class=section><div class=container><div class="subtitle tags is-6 is-pulled-right"><a class="subtitle is-6" href=/tags/docker>#docker</a>
| <a class="subtitle is-6" href=/tags/pentaho>#pentaho</a>
| <a class="subtitle is-6" href=/tags/proxy>#proxy</a></div><h2 class="subtitle is-6">December 10, 2016</h2><h1 class=title>Setup an easy reverse proxy to the biserver</h1><div class=content><h1 id=problem>Problem</h1><p>You have a biserver serving up information either directly or embedded into
some website. You need to open up the biserver to the rest of the world but want
to prevent access to certain endpoints. These endpoints might serve only internal
consumers, or have security implications.</p><p>We need to limit the attack service of a biserver!</p><p><img src=/images/mayday.png alt="proxy it" title="proxy it"></p><p>Traditionally one would spin up a new server, add an apache config to proxy forward
some requests to the backend. This adds complexity, moving parts, and lowers
agility.</p><p>In this post I'll suggest a simplification of the same approach, just in a
slightly more flexible way, obviously we'll containerize it.</p><h1 id=solution>Solution</h1><h2 id=ingredients>Ingredients</h2><ul><li>a <a href=https://github.com/docker/dockercloud-haproxy>haproxy container</a> with a pretty impressive featureset</li><li>a biserver 6.1 container with a wildly impressive <code>HelloWorld</code> cde dashboard <code>/pentaho/api/repos/%3Apublic%3AHelloWorld.wcdf/generatedContent</code></li><li>a canary container that will informs us about missing resources</li><li>a docker-composition to glue these together:</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>version: <span style=color:#e6db74>&#39;2&#39;</span>
services:
  biserver:
    image: pentaho/biserver:6.1
    ports:
      - 8080:8080
    environment:
      - VIRTUAL_HOST<span style=color:#f92672>=</span>...
      - VIRTUAL_HOST_WEIGHT<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>
  canary:
    image: httpd:latest
    environment:
      - VIRTUAL_HOST<span style=color:#f92672>=</span>http://*
      - VIRTUAL_HOST_WEIGHT<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
  proxy:
    image: dockercloud/haproxy
    links:
      - biserver
      - canary
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - 80:80
</code></pre></div><h2 id=round-1>Round 1</h2><p>We utilise the <code>VIRTUAL_HOST</code> <a href=https://github.com/docker/dockercloud-haproxy#global-and-default-settings-of-haproxy>options</a> of the proxy to whitelist our epic HelloWorld dashboard. By giving the proxy a higher <code>VIRTUAL_HOST_WEIGHT</code> we force traffic to first route via this <code>VIRTUAL_HOST</code> everything else falls through onto the canary container.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>VIRTUAL_HOST<span style=color:#f92672>=</span>http://*/pentaho/api/repos/%3Apublic%3AHelloWorld.wcdf/generatedContent
</code></pre></div><p>Looking at the dashboard directly.</p><p>![unproxied](/images/2016-12-10_biserver direct.png &ldquo;unproxied&rdquo;)</p><p>Now, lets view it via the proxy
<img src=/images/2016-12-10_biserverproxied.png alt=proxied title=proxied></p><p>But oh, the horror of my carefully crafted indenting, it has gone all haywire. And when we inspect the page we see what's going wrong:</p><p><img src=/images/2016-12-10_styling_horrors.png alt="styling horrors" title="styling horrors"></p><p>And funny enough, now the <code>canary</code> container comes to offer the same insight as well:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>canary_1    | 172.18.0.4 - - <span style=color:#f92672>[</span>10/Dec/2016:20:09:49 +0000<span style=color:#f92672>]</span> <span style=color:#e6db74>&#34;GET /pentaho/api/repos/pentaho-cdf/js/cdf-bootstrap-script-includes.js?v=decdbcb3b01341682f2ef9799798313c HTTP/1.1&#34;</span> <span style=color:#ae81ff>404</span> <span style=color:#ae81ff>263</span>
canary_1    | 172.18.0.4 - - <span style=color:#f92672>[</span>10/Dec/2016:20:09:49 +0000<span style=color:#f92672>]</span> <span style=color:#e6db74>&#34;GET /pentaho/api/repos/pentaho-cdf/css/cdf-bootstrap-style-includes.css?v=7bc42bb099ded22348e9c9b992045d67 HTTP/1.1&#34;</span> <span style=color:#ae81ff>404</span> <span style=color:#ae81ff>264</span>
canary_1    | 172.18.0.4 - - <span style=color:#f92672>[</span>10/Dec/2016:20:09:49 +0000<span style=color:#f92672>]</span> <span style=color:#e6db74>&#34;GET /pentaho/api/repos/pentaho-cdf-dd/js/CDF.js?v=7591bba3804971aeae31ca943022aba2 HTTP/1.1&#34;</span> <span style=color:#ae81ff>404</span> <span style=color:#ae81ff>240</span>
canary_1    | 172.18.0.4 - - <span style=color:#f92672>[</span>10/Dec/2016:20:09:49 +0000<span style=color:#f92672>]</span> <span style=color:#e6db74>&#34;GET /pentaho/api/repos/pentaho-cdf-dd/css/CDF-CSS.css?v=9dd48fd0265f0d8bcc30ac6afec3f0ff HTTP/1.1&#34;</span> <span style=color:#ae81ff>404</span> <span style=color:#ae81ff>246</span>
canary_1    | 172.18.0.4 - - <span style=color:#f92672>[</span>10/Dec/2016:20:09:52 +0000<span style=color:#f92672>]</span> <span style=color:#e6db74>&#34;GET /pentaho/api/repos/pentaho-cdf/js/cdf-bootstrap-script-includes.js?v=decdbcb3b01341682f2ef9799798313c HTTP/1.1&#34;</span> <span style=color:#ae81ff>404</span> <span style=color:#ae81ff>263</span>
canary_1    | 172.18.0.4 - - <span style=color:#f92672>[</span>10/Dec/2016:20:09:52 +0000<span style=color:#f92672>]</span> <span style=color:#e6db74>&#34;GET /pentaho/api/repos/pentaho-cdf/css/cdf-bootstrap-style-includes.css?v=7bc42bb099ded22348e9c9b992045d67 HTTP/1.1&#34;</span> <span style=color:#ae81ff>404</span> <span style=color:#ae81ff>264</span>
canary_1    | 172.18.0.4 - - <span style=color:#f92672>[</span>10/Dec/2016:20:09:52 +0000<span style=color:#f92672>]</span> <span style=color:#e6db74>&#34;GET /pentaho/api/repos/pentaho-cdf-dd/js/CDF.js?v=7591bba3804971aeae31ca943022aba2 HTTP/1.1&#34;</span> <span style=color:#ae81ff>404</span> <span style=color:#ae81ff>240</span>
canary_1    | 172.18.0.4 - - <span style=color:#f92672>[</span>10/Dec/2016:20:09:52 +0000<span style=color:#f92672>]</span> <span style=color:#e6db74>&#34;GET /pentaho/api/repos/pentaho-cdf-dd/css/CDF-CSS.css?v=9dd48fd0265f0d8bcc30ac6afec3f0ff HTTP/1.1&#34;</span> <span style=color:#ae81ff>404</span> <span style=color:#ae81ff>246</span>
canary_1    | 172.18.0.4 - - <span style=color:#f92672>[</span>10/Dec/2016:20:11:09 +0000<span style=color:#f92672>]</span> <span style=color:#e6db74>&#34;GET /pentaho/api/repos/pentaho-cdf/js/cdf-bootstrap-script-includes.js?v=decdbcb3b01341682f2ef9799798313c HTTP/1.1&#34;</span> <span style=color:#ae81ff>404</span> <span style=color:#ae81ff>263</span>
canary_1    | 172.18.0.4 - - <span style=color:#f92672>[</span>10/Dec/2016:20:11:09 +0000<span style=color:#f92672>]</span> <span style=color:#e6db74>&#34;GET /pentaho/api/repos/pentaho-cdf/css/cdf-bootstrap-style-includes.css?v=7bc42bb099ded22348e9c9b992045d67 HTTP/1.1&#34;</span> <span style=color:#ae81ff>404</span> <span style=color:#ae81ff>264</span>
canary_1    | 172.18.0.4 - - <span style=color:#f92672>[</span>10/Dec/2016:20:11:09 +0000<span style=color:#f92672>]</span> <span style=color:#e6db74>&#34;GET /pentaho/api/repos/pentaho-cdf-dd/js/CDF.js?v=7591bba3804971aeae31ca943022aba2 HTTP/1.1&#34;</span> <span style=color:#ae81ff>404</span> <span style=color:#ae81ff>240</span>
</code></pre></div><h2 id=round-2>Round 2</h2><p>So we whitelist two more paths:</p><ul><li><code>/pentaho/api/repos/pentaho-cdf/js/*</code></li><li><code>/pentaho/api/repos/pentaho-cdf/css/*</code></li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>VIRTUAL_HOST<span style=color:#f92672>=</span>http://*/pentaho/api/repos/%3Apublic%3AHelloWorld.wcdf/generatedContent,http://*/pentaho/api/repos/pentaho-cdf/css/*,http://*/pentaho/api/repos/pentaho-cdf/js/*
</code></pre></div><p>Et voila, indenting back from the death, but carefully proxied for only that particular resource we wanted to expose to the world <code>:-)</code>
<img src=/images/2016-12-10_epic_dashboard.png alt=epic title=epic></p><p>So the final composition looks like:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>version: <span style=color:#e6db74>&#39;2&#39;</span>
services:
  biserver:
    image: pentaho/biserver:6.1
    ports:
      - <span style=color:#ae81ff>8080</span>
    environment:
      - VIRTUAL_HOST<span style=color:#f92672>=</span>http://*/pentaho/api/repos/%3Apublic%3AHelloWorld.wcdf/generatedContent,http://*/pentaho/api/repos/pentaho-cdf/css/*,http://*/pentaho/api/repos/pentaho-cdf/js/*
      - VIRTUAL_HOST_WEIGHT<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>
      - GZIP_COMPRESSION_TYPE<span style=color:#f92672>=</span>text/html text/plain text/css text/javascript application/json
  canary:
    image: httpd:latest
    environment:
      - VIRTUAL_HOST<span style=color:#f92672>=</span>http://*
      - VIRTUAL_HOST_WEIGHT<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
      - GZIP_COMPRESSION_TYPE<span style=color:#f92672>=</span>text/html text/plain text/css text/javascript application/json
  proxy:
    image: dockercloud/haproxy
    links:
      - biserver
      - canary
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - 80:80
</code></pre></div><p>We have locked up the biserver completely, and we can dive deeper into the <a href=https://github.com/docker/dockercloud-haproxy#global-and-default-settings-of-haproxy>magic of the haproxy container</a>,
as it can do easy ssl termination as well, just change the proxy to:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>proxy:
  image: dockercloud/haproxy
  environment:
    - DEFAULT_SSL_CERT<span style=color:#f92672>=</span>-----&gt; my cert goes here
  links:
    - biserver
    - canary
  volumes:
    - /var/run/docker.sock:/var/run/docker.sock
  ports:
    - 443:443
</code></pre></div><div class=related><h3>Similar articles:</h3><ul><li><a href=/posts/slack-update-from-pdi/>Slack update from pdi</a></li><li><a href=/posts/pentaho-and-mesos/>Running pentaho on mesos - part 1</a></li><li><a href=/posts/pentahanl-spring-meetup/>Pentaho NL spring meetup</a></li><li><a href=/posts/jekyll-to-hugo/>Jekyll boooh, hugo yeah!</a></li><li><a href=/posts/2016-04-26-first-meetup-update/>Update: First pentaho nl meetup!</a></li></ul></div></div></div></section><section class=section><div class="container has-text-centered"><p>Copyright <a href=https://github.com/blijblijblij>Rogier Wessel</a> 2020</p></div></section></body></html>